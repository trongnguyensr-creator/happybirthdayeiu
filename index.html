<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Happy Birthday</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #ffecf5 0%, #fff5f9 50%, #e6f0ff 100%);
      color: #4a2c3f;
      display: grid;
      place-items: center;
      overflow: hidden;
      position: relative;
    }
    body::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 20%, rgba(173,216,230,0.18) 0%, transparent 40%),
                  radial-gradient(circle at 70% 80%, rgba(255,182,193,0.15) 0%, transparent 45%);
      animation: wavePulse 12s ease-in-out infinite alternate;
      pointer-events: none;
      z-index: -1;
    }
    @keyframes wavePulse {
      0% { transform: scale(1.0); opacity: 0.6; }
      50% { transform: scale(1.15); opacity: 0.8; }
      100% { transform: scale(1.0); opacity: 0.6; }
    }
    .container {
      position: relative;
      width: 100%;
      max-width: 360px;          /* ← nhỏ hơn trước */
      padding: 16px;
      z-index: 1;
    }
    #screen-input {
      background: rgba(255, 245, 250, 0.88);
      border: 1px solid #ffb6c1;
      border-radius: 20px;
      padding: 2.2rem 1.6rem;    /* ← padding nhỏ hơn */
      box-shadow: 0 10px 34px rgba(255,182,193,0.22);
      backdrop-filter: blur(10px);
      text-align: center;
      transition: opacity 0.7s ease, transform 0.7s ease;
    }
    #screen-input.hidden {
      opacity: 0;
      transform: scale(0.94);
      pointer-events: none;
    }
    h1 {
      font-size: 1.7rem;         /* ← nhỏ hơn */
      margin-bottom: 1.6rem;
      color: #e91e63;
      letter-spacing: 1.2px;
      text-shadow: 0 2px 6px rgba(233,30,99,0.15);
    }
    .code-display {
      font-size: 2.6rem;         /* ← nhỏ hơn */
      letter-spacing: 18px;
      font-weight: 700;
      color: #c2185b;
      background: rgba(255,255,255,0.7);
      border: 2px solid #f8bbd0;
      border-radius: 14px;
      padding: 12px 20px;
      margin: 1.2rem auto 1.8rem;
      width: 210px;              /* ← nhỏ hơn */
      min-height: 66px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.08);
    }
    .code-display.filled {
      border-color: #ec407a;
      color: #d81b60;
      background: rgba(255,235,238,0.9);
    }
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;                 /* ← khoảng cách nhỏ hơn */
      max-width: 240px;          /* ← nhỏ hơn */
      margin: 0 auto;
    }
    .key {
      aspect-ratio: 1;
      font-size: 1.6rem;         /* ← nhỏ hơn */
      font-weight: 600;
      color: #c2185b;
      background: linear-gradient(145deg, #fff0f5, #ffebee);
      border: 2px solid #f8bbd0;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.22s;
      box-shadow: 0 5px 12px rgba(233,30,99,0.12);
    }
    .key:hover {
      transform: translateY(-4px) scale(1.08);
      background: linear-gradient(145deg, #ffebee, #fff0f5);
      border-color: #ec407a;
      box-shadow: 0 10px 20px rgba(233,30,99,0.22);
    }
    .key:active {
      transform: translateY(1px) scale(0.96);
      box-shadow: 0 3px 8px rgba(233,30,99,0.18);
    }
    .key.zero {
      grid-column: 2;
    }
    #error-msg {
      margin-top: 1.2rem;
      color: #d81b60;
      font-weight: 500;
      min-height: 1.4em;
      opacity: 0;
      transition: opacity 0.4s;
    }
    #error-msg.show {
      opacity: 1;
    }
    #screen-letter {
      opacity: 0;
      transform: scale(0.92);
      transition: all 0.9s ease;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    #screen-letter.visible {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }
    .instruction {
      color: #c2185b;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 1.2rem;
      text-align: center;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }
    .envelope-wrapper {
      position: relative;
      width: 100%;
      max-width: 420px;          /* phong bì vẫn vừa đủ */
      perspective: 1100px;
    }
    .envelope {
      width: 100%;
      height: 240px;             /* ← phong bì nhỏ hơn */
      position: relative;
      cursor: pointer;
      transition: transform 0.5s ease;
      margin-bottom: 1.6rem;
    }
    .envelope:hover:not(.open):not(.closing) {
      transform: translateY(-6px);
    }
    .envelope-body {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, #fff5f9, #ffebee);
      border: 3px solid #f8bbd0;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(233,30,99,0.18);
      z-index: 1;
    }
    .flap {
      position: absolute;
      width: 100%;
      height: 52%;
      top: 0;
      left: 0;
      background: linear-gradient(to bottom, #ffe0e8, #ffcdd2);
      border: 3px solid #f8bbd0;
      border-bottom: none;
      border-radius: 14px 14px 0 0;
      transform-origin: top center;
      transition: transform 1s cubic-bezier(0.23, 1, 0.32, 1);
      z-index: 3;
      clip-path: polygon(0 0, 100% 0, 50% 100%);
      box-shadow: 0 7px 18px rgba(233,30,99,0.15);
    }
    .envelope.open .flap {
      transform: rotateX(-180deg);
    }
    .letter {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 92%;
      max-width: 380px;          /* ← khung thư hơi nhỏ hơn nhưng vẫn rộng rãi */
      height: 480px;             /* Giữ nguyên chiều cao để đọc thoải mái */
      background: #ffffff;
      border: 2px solid #ffebee;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 2rem 1.8rem;      /* Giữ padding để chữ thoáng */
      font-size: 0.95rem;
      line-height: 1.7;
      color: #4a2c3f;
      opacity: 0;
      z-index: 4;
      pointer-events: none;
      transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.6s;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .letter::-webkit-scrollbar {
      display: none;
    }
    .envelope.open .letter {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 480px) {
      .letter {
        width: 94%;
        height: 460px;           /* hơi giảm cho mobile nhưng vẫn đủ đọc */
        padding: 1.8rem 1.6rem;
        font-size: 0.94rem;
      }
    }
    @media (max-height: 700px) {
      .letter {
        height: 420px;
      }
    }
    .letter.closing {
      transform: translate(-50%, -50%) scale(0) !important;
      opacity: 0 !important;
    }
    .envelope.closing .flap {
      transform: rotateX(0deg) !important;
    }
    .bold { font-weight: bold; }
    .italic { font-style: italic; }
    .pink { color: #e91e63; font-weight: 600; }
  </style>
</head>
<body>
<div class="container">
  <div id="screen-input">
    <h1>Nhập Mã Bí Mật</h1>
    <div class="code-display" id="code-display">••••</div>
    <div class="keypad" id="keypad"></div>
    <div id="error-msg"></div>
  </div>

  <div id="screen-letter">
    <div class="instruction">✨ Nhấn vào phong bì để mở thư ✨</div>
 
    <div class="envelope-wrapper">
      <div class="envelope" id="envelope">
        <div class="envelope-body"></div>
        <div class="flap"></div>
        <div class="letter" id="letter">
          <h2>Gửi người đặc biệt của anh,</h2>
          <div class="letter-content" id="letter-content"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ──────────────────────────────────────────────
// JavaScript giữ nguyên như cũ
// ──────────────────────────────────────────────
const CORRECT_CODE = "1302";
const screenInput = document.getElementById("screen-input");
const screenLetter = document.getElementById("screen-letter");
const codeDisplay = document.getElementById("code-display");
const keypad = document.getElementById("keypad");
const errorMsg = document.getElementById("error-msg");
const envelope = document.getElementById("envelope");
const letter = document.getElementById("letter");
const letterContent = document.getElementById("letter-content");

const birthdaySong = new Audio("hpbd.mp3");
birthdaySong.volume = 0.65;

let currentCode = "";
let isTyping = false;
let isOpen = false;

const letterText = [
  "Chúc mừng sinh nhật <h>bé yêu</h>, tròn <h>20 tuổi</h>.",
  "Hôm nay là một ngày rất riêng - không chỉ vì sinh nhật bé, mà vì <b>từ hôm nay, bé lại lớn thêm một chút trong cuộc đời này</b>.",
  "Anh không mong điều gì quá lớn lao, chỉ mong những ngày sắp tới sẽ nhẹ nhàng hơn với bé, và nếu có mệt mỏi, thì chúng cũng sẽ qua đi thật nhanh.",
  "Cảm ơn bé vì đã <b>đến bên anh</b>, và còn quý hơn nữa là đã <b>ở lại</b>, ngay cả khi mọi thứ chưa từng hoàn hảo.",
  "Có thể anh không nói nhiều, nhưng trong lòng anh luôn biết rõ một điều: <i>bé là người anh muốn ở cạnh lâu dài</i>.",
  "Tuổi mới, anh mong bé luôn bình yên, luôn được yêu thương đúng cách, và khi cần một nơi để dựa vào, <b>anh vẫn ở đây</b>.",
  "Anh không hứa những điều xa vời, chỉ hứa sẽ <h>thương bé thật lâu</h>, theo cách chậm rãi và chân thành nhất.",
  "<i>Anh iu <333333</i>"
];

function applyFormatting(text) {
  return text
    .replace(/<b>(.*?)<\/b>/g, '<span class="bold">$1</span>')
    .replace(/<i>(.*?)<\/i>/g, '<span class="italic">$1</span>')
    .replace(/<h>(.*?)<\/h>/g, '<span class="pink">$1</span>');
}

function createKeypad() {
  for (let i = 1; i <= 9; i++) createKey(i);
  createKey(0, true);
}

function createKey(value, isZero = false) {
  const key = document.createElement("button");
  key.className = "key";
  if (isZero) key.classList.add("zero");
  key.textContent = value;
  key.addEventListener("click", () => {
    if (currentCode.length < 4) {
      currentCode += value;
      updateDisplay();
      if (currentCode.length === 4) checkCode();
    }
  });
  keypad.appendChild(key);
}

function updateDisplay() {
  codeDisplay.textContent = currentCode.padEnd(4, "•");
  codeDisplay.classList.toggle("filled", currentCode.length === 4);
}

function checkCode() {
  if (currentCode === CORRECT_CODE) {
    birthdaySong.play().catch(err => console.error("Không thể phát nhạc:", err));
    screenInput.classList.add("hidden");
    setTimeout(() => {
      screenInput.style.display = "none";
      screenLetter.classList.add("visible");
    }, 700);
  } else {
    errorMsg.textContent = "Mã không đúng. Thử lại nhé!";
    errorMsg.classList.add("show");
    currentCode = "";
    updateDisplay();
    codeDisplay.style.animation = "none";
    void codeDisplay.offsetWidth;
    codeDisplay.style.animation = "shake 0.5s";
  }
}

envelope.addEventListener("click", (e) => {
  e.stopPropagation();
  if (!envelope.classList.contains("open") && !isTyping) {
    envelope.classList.add("open");
    isOpen = true;
    setTimeout(() => startTyping(), 700);
  }
});

screenLetter.addEventListener("click", (e) => {
  if (!isOpen) return;
  const rect = envelope.getBoundingClientRect();
  const isOutside =
    e.clientX < rect.left ||
    e.clientX > rect.right ||
    e.clientY < rect.top ||
    e.clientY > rect.bottom;
  if (isOutside) {
    closeEnvelope();
  }
});

function closeEnvelope() {
  if (!isOpen) return;
  isOpen = false;
  isTyping = false;
  envelope.classList.add("closing");
  letter.classList.add("closing");
  setTimeout(() => {
    envelope.classList.remove("open", "closing");
    letter.classList.remove("closing");
    letterContent.innerHTML = "";
  }, 1200);
}

async function startTyping() {
  isTyping = true;
  letterContent.innerHTML = "";
  for (let i = 0; i < letterText.length; i++) {
    if (!isOpen) return;
    const p = document.createElement("p");
    if (i === letterText.length - 1) {
      p.style.textAlign = "right";
      p.style.marginTop = "2rem";
    }
    p.classList.add("typing");
    letterContent.appendChild(p);
    const formatted = applyFormatting(letterText[i]);
    let displayed = "";
    for (let char of formatted) {
      if (!isOpen) return;
      displayed += char;
      p.innerHTML = displayed + '<span class="typing-cursor"></span>';
      await sleep(Math.random() * 30 + 20);
      letter.scrollTop = letter.scrollHeight;
    }
    p.innerHTML = displayed;
    await sleep(400);
  }
  isTyping = false;
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Khởi tạo
createKeypad();
updateDisplay();
</script>
</body>
</html>
